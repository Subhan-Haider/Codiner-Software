name: Security Audit

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: "0 2 * * *"
  pull_request:
    branches: [main]
    paths:
      - "package.json"
      - "package-lock.json"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Run npm audit
        id: audit
        run: |
          # Run audit and save results
          npm audit --json > audit.json || true

          # Check if there are vulnerabilities
          VULN_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities | .info + .low + .moderate + .high + .critical')
          echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT

          # Extract severity counts
          INFO_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities.info')
          LOW_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities.low')
          MODERATE_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities.moderate')
          HIGH_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities.high')
          CRITICAL_COUNT=$(cat audit.json | jq -r '.metadata.vulnerabilities.critical')

          echo "info=$INFO_COUNT" >> $GITHUB_OUTPUT
          echo "low=$LOW_COUNT" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE_COUNT" >> $GITHUB_OUTPUT
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

          echo "Found $VULN_COUNT total vulnerabilities"

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.audit.outputs.vuln_count != '0'
        uses: actions/github-script@v7
        env:
          VULN_COUNT: ${{ steps.audit.outputs.vuln_count }}
          INFO: ${{ steps.audit.outputs.info }}
          LOW: ${{ steps.audit.outputs.low }}
          MODERATE: ${{ steps.audit.outputs.moderate }}
          HIGH: ${{ steps.audit.outputs.high }}
          CRITICAL: ${{ steps.audit.outputs.critical }}
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));

            let comment = `## ðŸ”’ Security Audit Results\n\n`;

            const info = parseInt(process.env.INFO);
            const low = parseInt(process.env.LOW);
            const moderate = parseInt(process.env.MODERATE);
            const high = parseInt(process.env.HIGH);
            const critical = parseInt(process.env.CRITICAL);

            if (critical > 0 || high > 0) {
              comment += `âš ï¸ **Action Required**: This PR introduces dependencies with security vulnerabilities.\n\n`;
            }

            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            if (critical > 0) comment += `| ðŸ”´ Critical | ${critical} |\n`;
            if (high > 0) comment += `| ðŸŸ  High | ${high} |\n`;
            if (moderate > 0) comment += `| ðŸŸ¡ Moderate | ${moderate} |\n`;
            if (low > 0) comment += `| ðŸŸ¢ Low | ${low} |\n`;
            if (info > 0) comment += `| â„¹ï¸ Info | ${info} |\n`;

            comment += `\n**Total vulnerabilities**: ${process.env.VULN_COUNT}\n\n`;

            // Add some vulnerability details if available
            if (audit.vulnerabilities) {
              const vulns = Object.entries(audit.vulnerabilities).slice(0, 5);
              if (vulns.length > 0) {
                comment += `### Top Vulnerabilities:\n\n`;
                for (const [pkg, details] of vulns) {
                  const severity = details.via?.[0]?.severity || 'unknown';
                  const title = details.via?.[0]?.title || 'No title';
                  comment += `- **${pkg}** (${severity}): ${title}\n`;
                }
                if (Object.keys(audit.vulnerabilities).length > 5) {
                  comment += `\n...and ${Object.keys(audit.vulnerabilities).length - 5} more.\n`;
                }
              }
            }

            comment += `\n<details>\n`;
            comment += `<summary>How to fix</summary>\n\n`;
            comment += `Run \`npm audit fix\` to automatically fix vulnerabilities where possible.\n\n`;
            comment += `For manual fixes:\n`;
            comment += `1. Review the vulnerabilities with \`npm audit\`\n`;
            comment += `2. Update affected packages to secure versions\n`;
            comment += `3. Test thoroughly after updates\n`;
            comment += `</details>\n`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Audit Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Create issue for scheduled audit
        if: github.event_name == 'schedule' && steps.audit.outputs.vuln_count != '0'
        uses: actions/github-script@v7
        env:
          VULN_COUNT: ${{ steps.audit.outputs.vuln_count }}
          INFO: ${{ steps.audit.outputs.info }}
          LOW: ${{ steps.audit.outputs.low }}
          MODERATE: ${{ steps.audit.outputs.moderate }}
          HIGH: ${{ steps.audit.outputs.high }}
          CRITICAL: ${{ steps.audit.outputs.critical }}
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));

            const critical = parseInt(process.env.CRITICAL);
            const high = parseInt(process.env.HIGH);

            // Only create issue if there are high or critical vulnerabilities
            if (critical === 0 && high === 0) {
              console.log('No critical or high vulnerabilities, skipping issue creation');
              return;
            }

            let body = `## ðŸ”’ Security Vulnerabilities Detected\n\n`;
            body += `The automated security audit has found vulnerabilities in dependencies:\n\n`;
            body += `| Severity | Count |\n`;
            body += `|----------|-------|\n`;
            if (critical > 0) body += `| ðŸ”´ Critical | ${critical} |\n`;
            if (high > 0) body += `| ðŸŸ  High | ${high} |\n`;

            if (audit.vulnerabilities) {
              const vulns = Object.entries(audit.vulnerabilities)
                .filter(([_, details]) => {
                  const severity = details.via?.[0]?.severity || '';
                  return severity === 'critical' || severity === 'high';
                })
                .slice(0, 10);
              
              if (vulns.length > 0) {
                body += `\n### Affected Packages:\n\n`;
                for (const [pkg, details] of vulns) {
                  const severity = details.via?.[0]?.severity || 'unknown';
                  const title = details.via?.[0]?.title || 'No title';
                  const url = details.via?.[0]?.url || '';
                  body += `- **${pkg}** (${severity}): ${title}`;
                  if (url) body += ` [More info](${url})`;
                  body += `\n`;
                }
              }
            }

            body += `\n### Action Items:\n\n`;
            body += `1. Review vulnerabilities with \`npm audit\`\n`;
            body += `2. Run \`npm audit fix\` to auto-fix where possible\n`;
            body += `3. Manually update packages that can't be auto-fixed\n`;
            body += `4. Test thoroughly after updates\n\n`;
            body += `_This issue was automatically generated by the Security Audit workflow._`;

            // Check if similar issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated',
              per_page: 10
            });

            const existingIssue = issues.find(issue => 
              issue.title.includes('Security Vulnerabilities Detected')
            );

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['security', 'automated']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }
