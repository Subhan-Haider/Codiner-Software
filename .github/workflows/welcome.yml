name: Welcome First-Time Contributors

on:
  pull_request_target:
    types: [opened]
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    
    steps:
      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const isIssue = context.eventName.includes('issue');
            const isPR = context.eventName.includes('pull_request');
            
            const author = context.payload.issue?.user.login || context.payload.pull_request?.user.login;
            const number = context.payload.issue?.number || context.payload.pull_request?.number;
            
            // Check if this is the user's first contribution
            const { data: contributions } = isIssue 
              ? await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  creator: author,
                  per_page: 2
                })
              : await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'all',
                  per_page: 2
                });
            
            // Filter to only this user's contributions
            const userContributions = isIssue
              ? contributions.filter(i => i.user.login === author)
              : contributions.filter(pr => pr.user.login === author);
            
            // If this is their first contribution, welcome them
            if (userContributions.length === 1) {
              let message = '';
              
              if (isIssue) {
                message = `üëã Welcome to Codiner, @${author}!\n\n` +
                  "Thank you for opening your first issue! We appreciate you taking the time to contribute to the project.\n\n" +
                  "Here's what happens next:\n" +
                  "- Our team will review your issue shortly\n" +
                  "- If you've found a bug, we'll work on reproducing it\n" +
                  "- If you've requested a feature, we'll discuss its feasibility\n" +
                  "- Feel free to add more details if needed\n\n" +
                  "While you wait, you might want to:\n" +
                  "- ‚≠ê Star the repository if you find it useful\n" +
                  `- üìñ Check our [CONTRIBUTING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md) guide\n` +
                  "- üí¨ Join discussions in other issues\n\n" +
                  "Thanks again for contributing! üéâ";
              } else {
                message = `üëã Welcome to Codiner, @${author}!\n\n` +
                  "Thank you for opening your first pull request! We're excited to review your contribution.\n\n" +
                  "Here's what happens next:\n" +
                  "- Automated checks will run on your PR\n" +
                  "- Our team will review your changes\n" +
                  "- We may request some changes or ask questions\n" +
                  "- Once approved, your PR will be merged! üéâ\n\n" +
                  "A few tips:\n" +
                  "- Make sure all CI checks pass\n" +
                  "- Keep your PR focused on a single concern\n" +
                  "- Respond to review comments promptly\n" +
                  "- Feel free to ask questions if anything is unclear\n\n" +
                  "Thank you for contributing to Codiner! We appreciate your effort in making this project better. üôå\n\n" +
                  "**Resources:**\n" +
                  `- [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)\n` +
                  `- [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)`;
              }
              
              const commentFunc = isIssue 
                ? github.rest.issues.createComment
                : github.rest.issues.createComment; // Same API for both
              
              await commentFunc({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: message
              });
              
              // Add first-time-contributor label to PRs
              if (isPR) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  labels: ['first-time-contributor']
                });
              }
              
              console.log(`Welcomed first-time contributor: ${author}`);
            }
