name: PR Size Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-pr-size:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR size and label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Get PR files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            // Calculate total changes
            const totalChanges = files.reduce((sum, file) => 
              sum + file.additions + file.deletions, 0
            );

            // Determine size label
            let sizeLabel = '';
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 250) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 1000) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }

            // Get current labels
            const currentLabels = pr.labels.map(label => label.name);

            // Remove old size labels
            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];
            const labelsToRemove = currentLabels.filter(label => 
              sizeLabels.includes(label) && label !== sizeLabel
            );

            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label
              }).catch(() => {
                // Ignore errors if label doesn't exist
              });
            }

            // Add new size label if not already present
            if (!currentLabels.includes(sizeLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [sizeLabel]
              });
            }

            // Add helpful comment on very large PRs
            if (totalChanges >= 1000) {
              const comment = `## ðŸ“ Large Pull Request Detected
              
              This PR has **${totalChanges}** lines of changes. Consider:
              - Breaking it into smaller, focused PRs
              - Providing additional context in the description
              - Highlighting the most important changes for reviewers
              
              Large PRs are harder to review and more likely to introduce bugs.
              `;
              
              // Check if we already commented
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });
              
              const alreadyCommented = comments.some(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Large Pull Request Detected')
              );
              
              if (!alreadyCommented) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
            }
