name: Auto-Update Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Check for outdated packages
        id: outdated
        run: |
          # Run npm outdated and capture output
          npm outdated --json > outdated.json || true

          # Check if there are any outdated packages
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # Parse and format for readability
            node -e "
            const data = require('./outdated.json');
            let critical = [];
            let major = [];
            let minor = [];
            
            Object.entries(data).forEach(([pkg, info]) => {
              const current = info.current || 'N/A';
              const wanted = info.wanted || 'N/A';
              const latest = info.latest || 'N/A';
              const type = info.type || 'dependencies';
              
              const entry = \`- \${pkg}: \${current} â†’ \${latest} (type: \${type})\`;
              
              // Determine severity based on version jump
              const currentMajor = parseInt(current.split('.')[0]);
              const latestMajor = parseInt(latest.split('.')[0]);
              
              if (latestMajor > currentMajor + 1) {
                critical.push(entry);
              } else if (latestMajor > currentMajor) {
                major.push(entry);
              } else {
                minor.push(entry);
              }
            });
            
            console.log('CRITICAL_UPDATES=' + JSON.stringify(critical));
            console.log('MAJOR_UPDATES=' + JSON.stringify(major));
            console.log('MINOR_UPDATES=' + JSON.stringify(minor));
            " > updates.txt
            
            source updates.txt
            echo "critical=$(echo $CRITICAL_UPDATES | jq -r 'join(\"\n\")')" >> $GITHUB_OUTPUT
            echo "major=$(echo $MAJOR_UPDATES | jq -r 'join(\"\n\")')" >> $GITHUB_OUTPUT
            echo "minor=$(echo $MINOR_UPDATES | jq -r 'join(\"\n\")')" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for updates
        if: steps.outdated.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));

            let critical = [];
            let major = [];
            let minor = [];

            Object.entries(outdated).forEach(([pkg, info]) => {
              const current = info.current || 'N/A';
              const latest = info.latest || 'N/A';
              const type = info.type || 'dependencies';
              
              const entry = `- \`${pkg}\`: ${current} â†’ ${latest} (${type})`;
              
              // Determine severity
              const currentMajor = parseInt(current.split('.')[0]);
              const latestMajor = parseInt(latest.split('.')[0]);
              
              if (latestMajor > currentMajor + 1) {
                critical.push(entry);
              } else if (latestMajor > currentMajor) {
                major.push(entry);
              } else {
                minor.push(entry);
              }
            });

            let body = '## ðŸ“¦ Dependency Updates Available\n\n';
            body += 'The following packages have updates available:\n\n';

            if (critical.length > 0) {
              body += '### ðŸš¨ Critical Updates (multiple major versions behind)\n\n';
              body += critical.join('\n') + '\n\n';
            }

            if (major.length > 0) {
              body += '### âš ï¸ Major Updates\n\n';
              body += major.join('\n') + '\n\n';
            }

            if (minor.length > 0) {
              body += '### â„¹ï¸ Minor & Patch Updates\n\n';
              body += minor.join('\n') + '\n\n';
            }

            body += '---\n\n';
            body += '**Note**: Dependabot will automatically create PRs for these updates. ';
            body += 'This issue is for tracking purposes only.\n\n';
            body += '_This issue was automatically generated by the Auto-Update Check workflow._';

            // Check if similar issue already exists (open)
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated',
              per_page: 10
            });

            const existingIssue = issues.find(issue => 
              issue.title.includes('Dependency Updates Available')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“¦ Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['dependencies', 'automated']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }
