name: Auto Label Issues

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  label-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Label issue based on content
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = `${title} ${body}`;

            const labels = [];

            // Bug detection
            if (
              content.includes('bug') || 
              content.includes('error') || 
              content.includes('broken') ||
              content.includes('crash') ||
              content.includes('not working') ||
              content.includes('fails') ||
              content.includes('issue')
            ) {
              labels.push('bug');
            }

            // Feature request detection
            if (
              content.includes('feature') || 
              content.includes('enhancement') || 
              content.includes('add support') ||
              content.includes('would be nice') ||
              content.includes('suggestion')
            ) {
              labels.push('enhancement');
            }

            // Documentation detection
            if (
              content.includes('documentation') || 
              content.includes('docs') || 
              content.includes('readme') ||
              content.includes('guide')
            ) {
              labels.push('documentation');
            }

            // Question detection
            if (
              content.includes('question') || 
              content.includes('how to') || 
              content.includes('how do i') ||
              content.includes('help') ||
              title.includes('?')
            ) {
              labels.push('question');
            }

            // Performance detection
            if (
              content.includes('performance') || 
              content.includes('slow') || 
              content.includes('optimization') ||
              content.includes('speed')
            ) {
              labels.push('performance');
            }

            // Security detection
            if (
              content.includes('security') || 
              content.includes('vulnerability') || 
              content.includes('exploit') ||
              content.includes('cve')
            ) {
              labels.push('security');
            }

            // Platform-specific labels
            if (content.includes('windows')) {
              labels.push('windows');
            }
            if (content.includes('macos') || content.includes('mac os')) {
              labels.push('macos');
            }
            if (content.includes('linux')) {
              labels.push('linux');
            }
            if (content.includes('android')) {
              labels.push('android');
            }

            // Component-specific labels
            if (
              content.includes('ui') || 
              content.includes('interface') || 
              content.includes('frontend') ||
              content.includes('design')
            ) {
              labels.push('frontend');
            }

            if (
              content.includes('api') || 
              content.includes('backend') || 
              content.includes('server')
            ) {
              labels.push('backend');
            }

            if (
              content.includes('database') || 
              content.includes('sqlite') || 
              content.includes('storage')
            ) {
              labels.push('database');
            }

            if (
              content.includes('ai') || 
              content.includes('llm') || 
              content.includes('model') ||
              content.includes('ollama') ||
              content.includes('openai') ||
              content.includes('anthropic')
            ) {
              labels.push('ai');
            }

            // Add labels if any were detected
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(', ')}`);
            } else {
              console.log('No automatic labels matched');
            }

            // Add needs-triage label for all new issues
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['needs-triage']
            });
