// Firestore Security Rules for Codiner Firestore Integration
// This ensures users can only access their own data

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can read/write their own tasks
    // Allow public read for demo purposes, but restrict writes to authenticated users
    match /tasks/{taskId} {
      allow read: if true; // Allow anyone to read for demo
      allow write: if request.auth != null &&
                      (resource == null ||
                       resource.data.userId == request.auth.uid) &&
                      request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null &&
                       resource.data.userId == request.auth.uid;
    }

    // Projects collection - users can only access their own projects
    match /projects/{projectId} {
      allow read, write: if request.auth != null &&
                           (resource == null ||
                            resource.data.ownerId == request.auth.uid) &&
                           request.auth.uid == request.resource.data.ownerId;
    }

    // Shared tasks (for collaboration features)
    match /sharedTasks/{taskId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.auth.uid in request.resource.data.collaborators;
    }

    // Activity logs - users can only see their own logs
    match /logs/{logId} {
      allow read, write: if request.auth != null &&
                           resource.data.userId == request.auth.uid;
    }

    // App settings - per user
    match /settings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // File metadata (if using Firebase Storage integration)
    match /files/{fileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.auth.uid == request.resource.data.uploadedBy;
    }

    // Backup data - only for user's own data
    match /backups/{backupId} {
      allow read, write: if request.auth != null &&
                           resource.data.userId == request.auth.uid;
    }

    // Notifications - user-specific
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null &&
                           resource.data.userId == request.auth.uid;
    }

    // Analytics data (aggregated, read-only for users)
    match /analytics/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server can write
    }

    // Global app settings (read-only for all authenticated users)
    match /appSettings/{settingId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }

    // Demo data (public read for demo purposes)
    match /demo/{document=**} {
      allow read: if true;
      allow write: if false; // Read-only demo data
    }
  }
}
